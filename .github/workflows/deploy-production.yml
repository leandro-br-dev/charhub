name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Git ref to deploy (branch, tag, or commit SHA). Default: main'
        required: false
        default: 'main'

env:
  GCP_ZONE: us-central1-a
  VM_NAME: charhub-vm
  APP_DIR: /mnt/stateful_partition/charhub

jobs:
  pre-deploy-checks:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify main branch
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚ùå Only main branch can trigger automatic deploy"
            exit 1
          fi
          echo "‚úÖ On main branch - deploy will proceed"

      - name: List commits to deploy
        run: |
          echo "üìã Commits being deployed:"
          git log --oneline -5

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    environment:
      name: production
      url: https://charhub.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.sha }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY_PROD }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Static SSH Key for Deployment
        run: |
          echo "üîë Setting up SSH key for deployment..."
          mkdir -p $HOME/.ssh
          echo "${{ secrets.GH_DEPLOY_SSH_PRIVATE_KEY }}" > $HOME/.ssh/deploy_key
          chmod 600 $HOME/.ssh/deploy_key
          ssh-keygen -lf $HOME/.ssh/deploy_key 2>/dev/null || echo "Key loaded"
          echo "‚úÖ SSH key configured"

      - name: Set Deployment Variables
        id: deploy_vars
        run: |
          echo "üë§ Setting deployment variables..."
          # Using osLogin username for leandro_br_dev_gmail_com user
          echo "ssh_user=leandro_br_dev_gmail_com" >> $GITHUB_OUTPUT
          echo "ssh_host=34.66.66.202" >> $GITHUB_OUTPUT
          echo "‚úÖ Variables set"

      - name: Test SSH Connection
        run: |
          echo "üîå Testing SSH connection to VM..."
          SSH_USER="${{ steps.deploy_vars.outputs.ssh_user }}"
          SSH_HOST="${{ steps.deploy_vars.outputs.ssh_host }}"

          echo "SSH Config:"
          echo "  User: $SSH_USER"
          echo "  Host: $SSH_HOST"
          echo "  Key: $HOME/.ssh/deploy_key"

          # Try SSH with retries
          for attempt in 1 2 3; do
            echo ""
            echo "Attempt $attempt/3..."
            if ssh -o StrictHostKeyChecking=no \
                   -o UserKnownHostsFile=/dev/null \
                   -o ConnectTimeout=10 \
                   -i $HOME/.ssh/deploy_key \
                   "$SSH_USER@$SSH_HOST" \
                   'echo "‚úÖ SSH connection successful"'; then
              echo "‚úÖ SSH test passed on attempt $attempt"
              exit 0
            fi
            if [ $attempt -lt 3 ]; then
              echo "‚è≥ Waiting 5s before retry..."
              sleep 5
            fi
          done

          echo "‚ùå SSH test failed after 3 attempts"
          exit 1

      - name: Configure Git Safe Directory
        run: |
          echo "üîß Configuring git safe directory..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              "${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }}" \
              'bash -s' << 'EOF'
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            # Configure git to allow access to repository owned by different user
            sudo git config --add safe.directory "$APP_DIR"
            echo "‚úÖ Git safe directory configured"
          EOF

      - name: Create deployment backup
        run: |
          echo "üíæ Creating backup of current deployment..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              "${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }}" \
              'bash -s' << 'EOF'
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            sudo mkdir -p backups
            BACKUP_DIR="backups/backup_$(date +%Y%m%d_%H%M%S)"
            sudo mkdir -p "$BACKUP_DIR"
            sudo cp .env "$BACKUP_DIR/.env" || true
            sudo bash -c "git rev-parse HEAD > $BACKUP_DIR/commit.txt"
            echo "‚úÖ Backup created in $BACKUP_DIR"
          EOF

      - name: Fetch latest code
        run: |
          echo "üì• Updating code from GitHub..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              "${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }}" \
              'bash -s' << 'EOF'
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            sudo git fetch origin
            CURRENT_COMMIT=$(sudo git rev-parse HEAD)
            sudo git checkout main
            NEW_COMMIT=$(sudo git rev-parse HEAD)

            if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
              echo "‚ö†Ô∏è  No new commits to deploy"
              exit 0
            fi

            echo "üìù New commits:"
            sudo git log --oneline "$CURRENT_COMMIT".."$NEW_COMMIT"
          EOF

      - name: Stop running containers
        run: |
          echo "üõë Stopping containers..."

          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              ${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }} \
              'bash -s' << 'EOF'
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            sudo /var/lib/toolbox/bin/docker-compose down || true
            echo "‚úÖ Containers stopped"
          EOF

      - name: Build and start containers
        timeout-minutes: 30
        run: |
          echo "üî® Building and starting containers..."

          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              ${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }} \
              'bash -s' << 'EOF'
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            sudo /var/lib/toolbox/bin/docker-compose build --no-cache
            sudo /var/lib/toolbox/bin/docker-compose up -d
            echo "‚úÖ Containers started"
          EOF

      - name: Wait for services to be ready
        run: |
          echo "‚è≥ Waiting for services to start (30 seconds)..."
          sleep 30
          echo "‚úÖ Services should be ready"

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."

          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              ${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }} \
              'bash -s' << 'EOF'
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            sudo /var/lib/toolbox/bin/docker-compose exec -T backend npx prisma migrate deploy || {
              echo "‚ö†Ô∏è  No pending migrations or migration completed"
            }
            echo "‚úÖ Migrations completed"
          EOF

      - name: Health check
        timeout-minutes: 5
        run: |
          echo "üè• Running health checks..."

          for i in {1..30}; do
            echo "Attempt $i/30..."
            if curl -sf https://charhub.app/api/v1/health > /dev/null; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            sleep 5
          done

          echo "‚ùå Health check failed after 30 attempts"
          exit 1

      - name: Verify deployment
        run: |
          echo "üìä Deployment verification..."

          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              ${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }} \
              'bash -s' << 'EOF'
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            echo "üìã Running containers:"
            sudo /var/lib/toolbox/bin/docker-compose ps
            echo ""
            echo "üìù Current commit:"
            sudo git log -1 --oneline
            echo ""
            echo "‚úÖ Deployment verification complete"
          EOF

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "URL: https://charhub.app"
          echo "Commit: ${{ github.sha }}"

      - name: Rollback on failure
        if: failure()
        timeout-minutes: 10
        run: |
          echo "‚ùå Deployment failed! Initiating rollback..."

          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i $HOME/.ssh/deploy_key \
              ${{ steps.deploy_vars.outputs.ssh_user }}@${{ steps.deploy_vars.outputs.ssh_host }} \
              'bash -s' << 'EOF' || true
            set -e
            APP_DIR="/mnt/stateful_partition/charhub"
            cd "$APP_DIR"
            sudo git reset --hard HEAD~1
            sudo /var/lib/toolbox/bin/docker-compose down || true
            sudo /var/lib/toolbox/bin/docker-compose build
            sudo /var/lib/toolbox/bin/docker-compose up -d
            echo "‚úÖ Rollback completed"
          EOF

      - name: Cleanup SSH Key
        if: always()
        run: |
          echo "üßπ Cleaning up SSH key from runner..."
          rm -f $HOME/.ssh/deploy_key
          echo "‚úÖ SSH key removed"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: Prepare notification
        id: notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            STATUS="‚úÖ SUCCESS"
            EMOJI="‚úÖ"
          else
            STATUS="‚ùå FAILED"
            EMOJI="‚ùå"
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

      - name: Print deployment result
        run: |
          echo "Deployment Status: ${{ steps.notification.outputs.status }}"
          echo "Production URL: https://charhub.app"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
