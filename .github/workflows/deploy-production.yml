name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:

env:
  GCP_ZONE: us-central1-a
  VM_NAME: charhub-vm
  APP_DIR: /mnt/stateful_partition/charhub

jobs:
  pre-deploy-checks:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify main branch
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚ùå Only main branch can trigger automatic deploy"
            exit 1
          fi
          echo "‚úÖ On main branch - deploy will proceed"

      - name: List commits to deploy
        run: |
          echo "üìã Commits being deployed:"
          git log --oneline -5

  ci-gate:
    name: Wait for CI Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Backend CI to complete
        run: |
          echo "üîÑ Waiting for Backend CI workflow to complete..."

          # Get the current workflow run ID
          CURRENT_RUN_ID="${{ github.run_id }}"

          # Get the commit SHA
          COMMIT_SHA="${{ github.sha }}"

          # Poll for Backend CI completion (max 30 retries = 30 minutes)
          for i in {1..30}; do
            echo "Attempt $i/30..."

            # Get the latest Backend CI run for this commit
            BACKEND_CI_RUN=$(gh run list \
              --workflow=backend-ci.yml \
              --branch=main \
              --json status,conclusion,databaseId \
              --limit=1 \
              --jq '.[] | {status, conclusion, id: .databaseId}' \
              2>/dev/null)

            if [ -z "$BACKEND_CI_RUN" ]; then
              echo "  ‚ÑπÔ∏è  Backend CI not yet started, waiting..."
              sleep 60
              continue
            fi

            STATUS=$(echo "$BACKEND_CI_RUN" | jq -r '.status')
            CONCLUSION=$(echo "$BACKEND_CI_RUN" | jq -r '.conclusion')

            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "‚úÖ Backend CI passed!"
                exit 0
              else
                echo "‚ùå Backend CI failed (conclusion: $CONCLUSION)"
                exit 1
              fi
            else
              echo "  ‚è≥ Backend CI still running (status: $STATUS)"
              sleep 60
            fi
          done

          echo "‚ùå Timeout waiting for Backend CI to complete (30 minutes)"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, ci-gate]
    if: success()
    environment:
      name: production
      url: https://charhub.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY_PROD }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup SSH Key
        run: |
          echo "üîë Setting up SSH key..."
          mkdir -p $HOME/.ssh
          echo "${{ secrets.GH_DEPLOY_SSH_PRIVATE_KEY }}" > $HOME/.ssh/deploy_key
          chmod 600 $HOME/.ssh/deploy_key

          # Add host key to known_hosts to avoid warning
          ssh-keyscan -H 34.66.66.202 >> $HOME/.ssh/known_hosts 2>/dev/null || true

          echo "‚úÖ SSH key configured"

      - name: Test SSH Connection
        run: |
          echo "üîå Testing SSH connection..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=10 \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=10 \
              -i $HOME/.ssh/deploy_key \
              leandro_br_dev_gmail_com@34.66.66.202 \
              'echo "‚úÖ SSH connection successful"'

      - name: Pull Latest Code
        run: |
          echo "üì• Pulling latest code from GitHub..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=10 \
              -i $HOME/.ssh/deploy_key \
              leandro_br_dev_gmail_com@34.66.66.202 \
              'bash -s' << 'PULL'
          APP_DIR="/mnt/stateful_partition/charhub"
          cd "$APP_DIR"

          # Fix all file permissions (from previous sudo operations)
          sudo chown -R leandro_br_dev_gmail_com:leandro_br_dev_gmail_com "$APP_DIR" 2>/dev/null || true
          sudo chmod -R u+w "$APP_DIR" 2>/dev/null || true

          # Configure git to allow access to repo (BEFORE any git commands)
          git config --global --add safe.directory "$APP_DIR" 2>/dev/null || true
          git config --local --add safe.directory "$APP_DIR" 2>/dev/null || true

          # Verify safe.directory was set
          echo "‚úì Git safe.directory configured"

          git fetch origin
          BEFORE=$(git rev-parse HEAD)
          git reset --hard origin/main
          AFTER=$(git rev-parse HEAD)

          if [ "$BEFORE" = "$AFTER" ]; then
            echo "‚ö†Ô∏è  No new commits"
            exit 0
          fi

          echo "üìù New commits:"
          git log --oneline $BEFORE..$AFTER
          PULL

      - name: Sync Cloudflare Credentials
        run: |
          echo "üîê Syncing Cloudflare credentials..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=10 \
              -i $HOME/.ssh/deploy_key \
              leandro_br_dev_gmail_com@34.66.66.202 \
              'bash -s' << 'CREDS'
          APP_DIR="/mnt/stateful_partition/charhub"
          # Verify cloudflared config directory exists
          sudo mkdir -p "$APP_DIR/cloudflared/config/prod"
          sudo chmod 755 "$APP_DIR/cloudflared/config/prod"
          CREDS

      - name: Rebuild Containers
        run: |
          echo "üî® Rebuilding containers..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=10 \
              -i $HOME/.ssh/deploy_key \
              leandro_br_dev_gmail_com@34.66.66.202 \
              'bash -s' << 'BUILD'
          cd /mnt/stateful_partition/charhub
          COMPOSE="/var/lib/toolbox/bin/docker-compose"

          # Set HOME to user's home directory (Container-Optimized OS best practice)
          # This allows Docker to create config files in /home/user/.docker/
          export HOME="/home/leandro_br_dev_gmail_com"

          echo "Stopping containers..."
          sudo -E HOME="$HOME" $COMPOSE down --remove-orphans -v 2>/dev/null || true

          echo "Waiting for containers to fully stop..."
          sleep 5

          echo "Building with cache (use manual workflow for clean build)..."
          sudo -E HOME="$HOME" $COMPOSE build --pull

          echo "Starting containers..."
          sudo -E HOME="$HOME" $COMPOSE up -d

          sleep 15
          echo "‚úÖ Containers started"
          BUILD

      - name: Health Check
        run: |
          echo "üè• Running health check..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=10 \
              -i $HOME/.ssh/deploy_key \
              leandro_br_dev_gmail_com@34.66.66.202 \
              'bash -s' << 'HEALTH'
          cd /mnt/stateful_partition/charhub
          COMPOSE="/var/lib/toolbox/bin/docker-compose"

          for i in {1..30}; do
            echo "Attempt $i/30..."

            # Check if backend container is healthy
            STATUS=$(sudo $COMPOSE ps backend --format='{{.Status}}' 2>/dev/null)

            if [[ "$STATUS" =~ "healthy" ]]; then
              echo "‚úÖ Backend healthy: $STATUS"
              exit 0
            elif [[ "$STATUS" =~ "Up" ]]; then
              echo "‚ÑπÔ∏è  Backend running (health check may still be initializing): $STATUS"
              # Give a few more attempts for health check to complete
              if [ $i -gt 5 ]; then
                exit 0
              fi
            fi

            sleep 5
          done

          echo "‚ùå Health check failed - backend not healthy after 30 attempts"
          echo "Final status:"
          sudo $COMPOSE ps backend
          exit 1
          HEALTH

      - name: Verify Deployment
        run: |
          echo "üìä Verifying deployment..."
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=10 \
              -i $HOME/.ssh/deploy_key \
              leandro_br_dev_gmail_com@34.66.66.202 \
              'bash -s' << 'VERIFY'
          cd /mnt/stateful_partition/charhub

          # Fix all file permissions
          sudo chown -R leandro_br_dev_gmail_com:leandro_br_dev_gmail_com . 2>/dev/null || true
          sudo chmod -R u+w . 2>/dev/null || true

          # Configure git BEFORE using git commands
          git config --global --add safe.directory "$(pwd)" 2>/dev/null || true
          git config --local --add safe.directory "$(pwd)" 2>/dev/null || true

          COMPOSE="/var/lib/toolbox/bin/docker-compose"

          echo "Container status:"
          sudo $COMPOSE ps

          echo ""
          echo "Git status:"
          git log -1 --oneline

          echo ""
          echo "‚úÖ Deployment verified"
          VERIFY

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "URL: https://charhub.app"
          echo "Commit: ${{ github.sha }}"

      - name: Cleanup SSH Key
        if: always()
        run: |
          rm -f $HOME/.ssh/deploy_key
          echo "‚úÖ SSH key cleaned up"
