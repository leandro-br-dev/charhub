name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Git ref to deploy (branch, tag, or commit SHA). Default: main'
        required: false
        default: 'main'

env:
  GCP_ZONE: us-central1-a
  VM_NAME: charhub-vm
  APP_DIR: /mnt/stateful_partition/charhub

jobs:
  pre-deploy-checks:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify main branch
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚ùå Only main branch can trigger automatic deploy"
            exit 1
          fi
          echo "‚úÖ On main branch - deploy will proceed"

      - name: List commits to deploy
        run: |
          echo "üìã Commits being deployed:"
          git log --oneline -5

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    environment:
      name: production
      url: https://charhub.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.sha }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY_PROD }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Generate Ephemeral SSH Key
        run: |
          echo "üîë Generating ephemeral SSH key for this deployment..."
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/deploy_key -C "github-actions-$(date +%s)"
          echo "‚úÖ SSH key generated"
          ssh-keygen -lf ~/.ssh/deploy_key.pub

      - name: Register SSH Key with OS Login (TTL 10min)
        run: |
          echo "üìù Registering SSH key with osLogin..."
          gcloud compute os-login ssh-keys add \
            --key-file=$HOME/.ssh/deploy_key.pub \
            --ttl=600s
          echo "‚úÖ SSH key registered with 10-minute TTL"

      - name: Get OS Login Username
        id: oslogin
        run: |
          echo "üë§ Setting OS Login username..."
          # The unique ID for service account github-deployer@charhub-prod.iam.gserviceaccount.com is stable
          UNIQUE_ID="110491369899107386224"
          echo "username=sa_${UNIQUE_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ OS Login username: sa_${UNIQUE_ID}"

      - name: Test SSH Connection
        run: |
          echo "üîå Testing SSH connection to VM..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'echo "‚úÖ SSH connection successful"' || exit 1

      - name: Create deployment backup
        run: |
          echo "üíæ Creating backup of current deployment..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'bash -s' << 'EOF'
            set -e
            cd ${{ env.APP_DIR }}
            mkdir -p backups
            BACKUP_DIR="backups/backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            cp .env "$BACKUP_DIR/.env" || true
            git rev-parse HEAD > "$BACKUP_DIR/commit.txt"
            echo "‚úÖ Backup created in $BACKUP_DIR"
          EOF

      - name: Fetch latest code
        run: |
          echo "üì• Updating code from GitHub..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'bash -s' << 'EOF'
            set -e
            cd ${{ env.APP_DIR }}
            git fetch origin
            CURRENT_COMMIT=$(git rev-parse HEAD)
            git checkout ${{ github.event.inputs.version || 'main' }}
            NEW_COMMIT=$(git rev-parse HEAD)

            if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
              echo "‚ö†Ô∏è  No new commits to deploy"
              exit 0
            fi

            echo "üìù New commits:"
            git log --oneline "$CURRENT_COMMIT".."$NEW_COMMIT"
          EOF

      - name: Stop running containers
        run: |
          echo "üõë Stopping containers..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'bash -s' << 'EOF'
            set -e
            cd ${{ env.APP_DIR }}
            sudo /var/lib/toolbox/bin/docker-compose down || true
            echo "‚úÖ Containers stopped"
          EOF

      - name: Build and start containers
        timeout-minutes: 30
        run: |
          echo "üî® Building and starting containers..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'bash -s' << 'EOF'
            set -e
            cd ${{ env.APP_DIR }}
            sudo /var/lib/toolbox/bin/docker-compose build --no-cache
            sudo /var/lib/toolbox/bin/docker-compose up -d
            echo "‚úÖ Containers started"
          EOF

      - name: Wait for services to be ready
        run: |
          echo "‚è≥ Waiting for services to start (30 seconds)..."
          sleep 30
          echo "‚úÖ Services should be ready"

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'bash -s' << 'EOF'
            set -e
            cd ${{ env.APP_DIR }}
            sudo /var/lib/toolbox/bin/docker-compose exec -T backend npx prisma migrate deploy || {
              echo "‚ö†Ô∏è  No pending migrations or migration completed"
            }
            echo "‚úÖ Migrations completed"
          EOF

      - name: Health check
        timeout-minutes: 5
        run: |
          echo "üè• Running health checks..."

          for i in {1..30}; do
            echo "Attempt $i/30..."
            if curl -sf https://charhub.app/api/v1/health > /dev/null; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            sleep 5
          done

          echo "‚ùå Health check failed after 30 attempts"
          exit 1

      - name: Verify deployment
        run: |
          echo "üìä Deployment verification..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'bash -s' << 'EOF'
            set -e
            cd ${{ env.APP_DIR }}
            echo "üìã Running containers:"
            sudo /var/lib/toolbox/bin/docker-compose ps
            echo ""
            echo "üìù Current commit:"
            git log -1 --oneline
            echo ""
            echo "‚úÖ Deployment verification complete"
          EOF

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "URL: https://charhub.app"
          echo "Commit: ${{ github.sha }}"

      - name: Rollback on failure
        if: failure()
        timeout-minutes: 10
        run: |
          echo "‚ùå Deployment failed! Initiating rollback..."
          VM_IP=34.66.66.202
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/deploy_key \
              ${{ steps.oslogin.outputs.username }}@${VM_IP} \
              'bash -s' << 'EOF' || true
            set -e
            cd ${{ env.APP_DIR }}
            git reset --hard HEAD~1
            sudo /var/lib/toolbox/bin/docker-compose down || true
            sudo /var/lib/toolbox/bin/docker-compose build
            sudo /var/lib/toolbox/bin/docker-compose up -d
            echo "‚úÖ Rollback completed"
          EOF

      - name: Cleanup SSH Key
        if: always()
        run: |
          echo "üßπ Cleaning up ephemeral SSH key..."
          gcloud compute os-login ssh-keys remove \
            --key-file=$HOME/.ssh/deploy_key.pub || true
          rm -f $HOME/.ssh/deploy_key $HOME/.ssh/deploy_key.pub
          echo "‚úÖ SSH key removed"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: Prepare notification
        id: notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            STATUS="‚úÖ SUCCESS"
            EMOJI="‚úÖ"
          else
            STATUS="‚ùå FAILED"
            EMOJI="‚ùå"
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

      - name: Print deployment result
        run: |
          echo "Deployment Status: ${{ steps.notification.outputs.status }}"
          echo "Production URL: https://charhub.app"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
