name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Git ref to deploy (branch, tag, or commit SHA). Default: main'
        required: false
        default: 'main'

env:
  GCP_ZONE: us-central1-a
  VM_NAME: charhub-vm
  APP_DIR: /mnt/stateful_partition/charhub

jobs:
  pre-deploy-checks:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify main branch
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "âŒ Only main branch can trigger automatic deploy"
            exit 1
          fi
          echo "âœ… On main branch - deploy will proceed"

      - name: List commits to deploy
        run: |
          echo "ðŸ“‹ Commits being deployed:"
          git log --oneline -5

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    environment:
      name: production
      url: https://charhub.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.sha }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY_PROD }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup SSH for Service Account
        env:
          SSH_KEY: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/google_compute_engine
          chmod 600 ~/.ssh/google_compute_engine
          ssh-keygen -y -f ~/.ssh/google_compute_engine > ~/.ssh/google_compute_engine.pub
          chmod 644 ~/.ssh/google_compute_engine.pub
          echo "âœ… SSH key configured for service account"

      - name: Test SSH connection
        run: |
          echo "ðŸ”Œ Testing SSH connection to VM..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="echo 'âœ… SSH connection successful'"

      - name: Create deployment backup
        run: |
          echo "ðŸ’¾ Creating backup of current deployment..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="
              cd ${{ env.APP_DIR }} &&
              mkdir -p backups &&
              BACKUP_DIR='backups/backup_'$(date +%Y%m%d_%H%M%S) &&
              mkdir -p \$BACKUP_DIR &&
              cp .env \$BACKUP_DIR/.env || true &&
              git rev-parse HEAD > \$BACKUP_DIR/commit.txt &&
              echo 'âœ… Backup created in '\$BACKUP_DIR
            "

      - name: Fetch latest code
        run: |
          echo "ðŸ“¥ Updating code from GitHub..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="
              cd ${{ env.APP_DIR }} &&
              git fetch origin &&
              CURRENT_COMMIT=\$(git rev-parse HEAD) &&
              git checkout ${{ github.event.inputs.version || 'main' }} &&
              NEW_COMMIT=\$(git rev-parse HEAD) &&

              if [ \"\$CURRENT_COMMIT\" = \"\$NEW_COMMIT\" ]; then
                echo 'âš ï¸  No new commits to deploy'
                exit 0
              fi &&

              echo 'ðŸ“ New commits:' &&
              git log --oneline \$CURRENT_COMMIT..\$NEW_COMMIT
            "

      - name: Stop running containers
        run: |
          echo "ðŸ›‘ Stopping containers..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="
              cd ${{ env.APP_DIR }} &&
              sudo /var/lib/toolbox/bin/docker-compose down || true &&
              echo 'âœ… Containers stopped'
            "

      - name: Build and start containers
        timeout-minutes: 30
        run: |
          echo "ðŸ”¨ Building and starting containers..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="
              cd ${{ env.APP_DIR }} &&
              sudo /var/lib/toolbox/bin/docker-compose build --no-cache &&
              sudo /var/lib/toolbox/bin/docker-compose up -d &&
              echo 'âœ… Containers started'
            "

      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for services to start (30 seconds)..."
          sleep 30
          echo "âœ… Services should be ready"

      - name: Run database migrations
        run: |
          echo "ðŸ—„ï¸  Running database migrations..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="
              cd ${{ env.APP_DIR }} &&
              sudo /var/lib/toolbox/bin/docker-compose exec -T backend npx prisma migrate deploy || {
                echo 'âš ï¸  No pending migrations or migration completed'
              } &&
              echo 'âœ… Migrations completed'
            "

      - name: Health check
        timeout-minutes: 5
        run: |
          echo "ðŸ¥ Running health checks..."

          for i in {1..30}; do
            echo "Attempt $i/30..."
            if curl -sf https://charhub.app/api/v1/health > /dev/null; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            sleep 5
          done

          echo "âŒ Health check failed after 30 attempts"
          exit 1

      - name: Verify deployment
        run: |
          echo "ðŸ“Š Deployment verification..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="
              cd ${{ env.APP_DIR }} &&
              echo 'ðŸ“‹ Running containers:' &&
              sudo /var/lib/toolbox/bin/docker-compose ps &&
              echo '' &&
              echo 'ðŸ“ Current commit:' &&
              git log -1 --oneline &&
              echo '' &&
              echo 'âœ… Deployment verification complete'
            "

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "URL: https://charhub.app"
          echo "Commit: ${{ github.sha }}"

      - name: Rollback on failure
        if: failure()
        timeout-minutes: 10
        run: |
          echo "âŒ Deployment failed! Initiating rollback..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="
              cd ${{ env.APP_DIR }} &&
              git reset --hard HEAD~1 &&
              sudo /var/lib/toolbox/bin/docker-compose down || true &&
              sudo /var/lib/toolbox/bin/docker-compose build &&
              sudo /var/lib/toolbox/bin/docker-compose up -d &&
              echo 'âœ… Rollback completed'
            "

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: Prepare notification
        id: notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            STATUS="âœ… SUCCESS"
            EMOJI="âœ…"
          else
            STATUS="âŒ FAILED"
            EMOJI="âŒ"
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

      - name: Print deployment result
        run: |
          echo "Deployment Status: ${{ steps.notification.outputs.status }}"
          echo "Production URL: https://charhub.app"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
