# Tag Classification System Documentation

**Purpose**: Content classification system for characters, stories, assets with age rating, content warnings, and multilingual translation support.

**Related Files**:
- Schema: `backend/prisma/schema.prisma` (Tag model, enums)
- Data Files: `backend/src/data/tags/tags-*.json` (seed data)
- Scripts: `backend/src/scripts/seedTags.ts`, `backend/src/scripts/buildTranslations.ts`
- Routes: `backend/src/routes/v1/tags.ts`
- Used by: Character, Story, and asset management features

## Overview

The tag classification system enables content categorization with:
- Age rating enforcement (L, 10+, 12+, 14+, 16+, 18+)
- Content warning tags (violence, nudity, sexual, etc.)
- Multi-language support for all 11 supported languages
- Efficient search and filtering
- Automatic translation via LLM

### Tag Types

| Type | Description | Examples |
|------|-----------|----------|
| `CHARACTER` | Character traits and archetypes | VTuber, Maid, Warrior, Tsundere |
| `STORY` | Narrative genres and themes | Fantasy, Romance, Isekai, LitRPG |
| `ASSET` | Visual assets and clothing | Kimono, Armor, Swimsuit, Crown |

### Age Ratings

| Rating | Age | Description |
|--------|-------|-----------|
| `L` | All ages | Safe for everyone |
| `TEN` | 10+ | Mild themes |
| `TWELVE` | 12+ | Moderate themes |
| `FOURTEEN` | 14+ | Mature themes, mild sexual references |
| `SIXTEEN` | 16+ | Strong themes, explicit language, moderate violence |
| `EIGHTEEN` | 18+ | Adult content, explicit sexual/violent content |

### Content Warnings

- `VIOLENCE` - Physical violence, fights
- `GORE` - Explicit violence, blood, injuries
- `SEXUAL` - Sexual content, innuendos
- `NUDITY` - Nudity or partial nudity
- `LANGUAGE` - Strong language, profanity
- `DRUGS` - Drug use or references
- `ALCOHOL` - Alcohol consumption
- `HORROR` - Horror themes, disturbing content
- `PSYCHOLOGICAL` - Psychological themes, mental health
- `DISCRIMINATION` - Discriminatory content, hate speech
- `CRIME` - Criminal activities
- `GAMBLING` - Gambling/betting themes

## Architecture

### Database Schema

```prisma
model Tag {
  id   String  @id @default(uuid())
  name String  // English name (used for search)
  type TagType // CHARACTER, STORY, ASSET, etc.

  // Content classification
  ageRating   AgeRating    @default(L)
  contentTags ContentTag[]

  // Metadata
  originalLanguageCode String?
  weight               Int     @default(1)
  searchable           Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (many-to-many)
  characters Character[]
  stories    Story[]
}
```

### Translation Flow

1. **Seed** generates base files in `backend/translations/_source/tags-*.json`
2. **Build** uses LLM (Gemini/OpenAI) to translate to all 11 languages
3. **Frontend** uses i18next to display translated tag names

**Note**: Technical terms (VTuber, BDSM, Anime) are automatically kept in English by the LLM.

## API/Usage

### Adding Tags to Characters

```typescript
// Create character with tags
const character = await prisma.character.create({
  data: {
    firstName: "Sakura",
    age: 16,
    gender: "female",
    userId: "user-id-here",
    ageRating: "TWELVE",
    contentTags: [],
    tags: {
      connect: [
        { id: "tag-id-1" }, // Anime
        { id: "tag-id-2" }, // Schoolgirl
        { id: "tag-id-3" }, // Tsundere
      ]
    }
  },
  include: {
    tags: true
  }
});
```

### Filtering Characters by Tags

```typescript
// Characters with specific tags
const characters = await prisma.character.findMany({
  where: {
    tags: {
      some: {
        id: {
          in: ["tag-id-1", "tag-id-2"]
        }
      }
    },
    ageRating: {
      lte: user.maxAgeRating
    },
    NOT: {
      contentTags: {
        hasSome: user.blockedTags
      }
    }
  },
  include: {
    tags: true
  }
});
```

### Searching for Tags

```typescript
// Find specific tag
const tag = await prisma.tag.findUnique({
  where: {
    name_type: {
      name: "VTuber",
      type: "CHARACTER"
    }
  }
});

// Get all character tags
const characterTags = await prisma.tag.findMany({
  where: {
    type: "CHARACTER",
    searchable: true
  },
  orderBy: {
    name: 'asc'
  }
});
```

## Usage Example: Complete Flow

```typescript
// 1. Find tags to connect
const vtuberTag = await prisma.tag.findUnique({
  where: { name_type: { name: "VTuber", type: "CHARACTER" } }
});

const idolTag = await prisma.tag.findUnique({
  where: { name_type: { name: "Idol", type: "CHARACTER" } }
});

// 2. Create character with tags
const vtuber = await prisma.character.create({
  data: {
    firstName: "Kizuna",
    lastName: "AI",
    age: null,
    gender: "female",
    userId: userId,
    ageRating: "L",
    contentTags: [],
    tags: {
      connect: [
        { id: vtuberTag.id },
        { id: idolTag.id }
      ]
    }
  },
  include: {
    tags: true
  }
});

// 3. Filter characters by tags
const animeCharacters = await prisma.character.findMany({
  where: {
    tags: {
      some: {
        name: "Anime",
        type: "CHARACTER"
      }
    },
    isPublic: true
  },
  include: {
    tags: {
      select: {
        name: true,
        type: true
      }
    }
  }
});
```

## Dependencies

- **Prisma**: Database ORM for tag queries
- **i18next**: Frontend translation display
- **LLM (Gemini/OpenAI)**: Automatic tag translation

## Important Notes

### Adding New Tags

1. **Edit data file** (`backend/src/data/tags/tags-*.json`)
2. **Run seed**: `npm run db:seed:tags` (populates DB + generates translation base)
3. **Build translations**: `npm run build:translations` (translates to all languages)
4. **Restart backend** (if needed)

```bash
# Dry-run to test
docker compose exec backend npm run db:seed:tags:dry

# Apply changes
docker compose exec backend npm run db:seed:tags
docker compose exec backend npm run build:translations
```

### Best Practices

**DO**:
- Use existing tags before creating new ones
- Combine different types (CHARACTER + ASSET) for better categorization
- Set appropriate ageRating based on most mature content
- Add contentTags for important warnings (SEXUAL, VIOLENCE, etc.)
- Test with dry-run before applying: `npm run db:seed:tags:dry`

**DON'T**:
- Duplicate tags - verify if already exists
- Mix languages - keep tag names in English
- Underestimate ageRating - be conservative to protect users
- Edit translations manually - always regenerate via build
- Modify files in `translations/{lang}/` - they're auto-generated

### Frontend Usage

```typescript
import { useTranslation } from 'react-i18next';

function CharacterFilters() {
  const { t } = useTranslation('tags-character');

  return (
    <div>
      <h3>{t('VTuber')}</h3>
      {/* Displays: "Virtual YouTuber ou criador de conte√∫do" (pt-BR) */}
    </div>
  );
}
```

## Testing

```bash
# Verify tags were created
docker compose exec backend npx prisma studio
# Access http://localhost:5555 and check Tag table

# Check translation files exist
ls backend/translations/_source/tags-*.json

# Force rebuild if needed
docker compose exec backend npm run build:translations:force
```

## Troubleshooting

**Tags don't appear after seed**
- Check Prisma Studio: `docker compose exec backend npx prisma studio`
- Verify seed completed successfully

**Translations not generated**
- Check base files: `ls backend/translations/_source/tags-*.json`
- Force rebuild: `npm run build:translations:force`

**Gemini quota error**
- Wait ~1 minute (15 requests/minute limit)
- Or use different provider: `npm run build:translations -- --provider=openai`

**Schema changes not reflected**
```bash
docker compose exec backend npx prisma generate
docker compose exec backend npx prisma migrate dev --name add_tag_changes
docker compose restart backend
```

## See Also

- **Database Schema**: `backend/prisma/schema.prisma`
- **Translation System**: `backend/src/services/translation/.docs.md`
- **API Routes**: `backend/src/routes/v1/tags.ts`
- **i18next Documentation**: https://www.i18next.com/
- **Prisma Documentation**: https://www.prisma.io/docs
