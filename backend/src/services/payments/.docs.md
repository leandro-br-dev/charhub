# Payment Service Documentation

**Purpose**: Payment processing integration with Stripe and PayPal for subscription management.

**Related Files**:
- Providers: `backend/src/services/payments/StripeProvider.ts`, `PayPalProvider.ts`
- Interface: `backend/src/services/payments/IPaymentProvider.ts`
- Factory: `backend/src/services/payments/PaymentProviderFactory.ts`
- Routes: `backend/src/routes/v1/payments.ts`, `backend/src/routes/v1/webhooks/stripe.ts`
- Used by: Subscription service, membership service

## Overview

The payment service provides a unified interface for processing payments through multiple providers:

- **Stripe**: Primary payment provider (credit/debit cards)
- **PayPal**: Alternative payment provider
- Separate Test and Live modes with different API keys
- Webhook handling for subscription events
- Automatic subscription status synchronization

### Payment Flow

```
User initiates payment
       ↓
Provider checkout (Stripe/PayPal)
       ↓
Payment processed
       ↓
Webhook received
       ↓
Subscription activated/updated
       ↓
Database updated
```

## Architecture

### Provider Interface

All payment providers implement `IPaymentProvider`:

```typescript
interface IPaymentProvider {
  name: string;
  createCheckoutSession(userId: string, planId: string): Promise<string>;
  cancelSubscription(subscriptionId: string): Promise<void>;
  validateWebhook(signature: string, payload: Buffer): Promise<boolean>;
  parseWebhookEvent(payload: Buffer): Promise<WebhookEvent>;
}
```

### Providers

**StripeProvider** (`StripeProvider.ts`):
- Handles Stripe checkout sessions
- Processes Stripe webhooks
- Validates webhook signatures
- Manages subscription lifecycle

**PayPalProvider** (`PayPalProvider.ts`):
- PayPal checkout integration
- PayPal webhook handling
- Subscription management

**PaymentProviderFactory** (`PaymentProviderFactory.ts`):
- Factory pattern for provider selection
- Returns appropriate provider based on configuration

### Webhook Handling

Webhooks are processed to synchronize subscription status:

1. **Webhook received** from provider
2. **Signature validated** using provider secret
3. **Event parsed** to extract subscription data
4. **Database updated** with new subscription status
5. **User notified** of changes

## Configuration

### Test Mode (Development)

**Stripe Setup**:

1. Get Test Mode keys from [Stripe Dashboard](https://dashboard.stripe.com/test/apikeys):
   - Secret Key: `sk_test_...`
   - Publishable Key: `pk_test_...`

2. Create Price IDs for each plan in [Products](https://dashboard.stripe.com/test/products):
   - Plus Plan: $5/month
   - Premium Plan: $10/month

3. Configure webhook at [Webhooks](https://dashboard.stripe.com/test/webhooks):
   - URL: `https://your-dev-domain.com/api/v1/webhooks/stripe`
   - Events: `customer.subscription.*`, `invoice.payment_*`
   - Signing Secret: `whsec_...`

**Environment Variables** (`.env`):
```bash
# Stripe Test Mode
STRIPE_SECRET_KEY=sk_test_your_secret_key_here
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here
STRIPE_PRICE_PLUS=price_your_test_plus_id
STRIPE_PRICE_PREMIUM=price_your_test_premium_id
```

**Frontend** (`frontend/.env`):
```bash
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_your_publishable_key_here
```

### Production Mode

**Stripe Setup**:

1. Activate Stripe account (business verification, banking info)
2. Get Live Mode keys from [Stripe Dashboard](https://dashboard.stripe.com/apikeys):
   - Secret Key: `sk_live_...`
   - Publishable Key: `pk_live_...`

3. Create Live Products and Prices

4. Configure production webhook:
   - URL: `https://charhub.app/api/v1/webhooks/stripe`

**Environment Variables** (Production `.env`):
```bash
# Stripe Live Mode
STRIPE_SECRET_KEY=sk_live_your_LIVE_secret_key_here
STRIPE_WEBHOOK_SECRET=whsec_your_LIVE_webhook_secret_here
STRIPE_PRICE_PLUS=price_your_LIVE_plus_id
STRIPE_PRICE_PREMIUM=price_your_LIVE_premium_id
```

**Frontend Production** (`frontend/.env.production`):
```bash
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_your_LIVE_publishable_key_here
```

### PayPal Configuration

**Sandbox (Test)**:
```bash
PAYPAL_MODE=sandbox
PAYPAL_CLIENT_ID=your_sandbox_client_id
PAYPAL_CLIENT_SECRET=your_sandbox_client_secret
```

**Live (Production)**:
```bash
PAYPAL_MODE=live
PAYPAL_CLIENT_ID=your_live_client_id
PAYPAL_CLIENT_SECRET=your_live_client_secret
```

## API/Usage

### Creating Checkout Session

```typescript
import { paymentProviderFactory } from '../services/payments/PaymentProviderFactory';

async function createSubscription(userId: string, planId: string) {
  const provider = paymentProviderFactory.getProvider('stripe');
  const checkoutUrl = await provider.createCheckoutSession(userId, planId);

  // Redirect user to checkoutUrl
  return checkoutUrl;
}
```

### Handling Webhooks

```typescript
// backend/src/routes/v1/webhooks/stripe.ts
import { paymentProviderFactory } from '../../../services/payments/PaymentProviderFactory';

router.post('/stripe', async (req, res) => {
  const signature = req.headers['stripe-signature'];
  const payload = req.body;

  const provider = paymentProviderFactory.getProvider('stripe');

  // Validate webhook
  const isValid = await provider.validateWebhook(signature, payload);
  if (!isValid) {
    return res.status(401).json({ error: 'Invalid signature' });
  }

  // Parse and process event
  const event = await provider.parseWebhookEvent(payload);

  // Update subscription in database
  await handleSubscriptionEvent(event);

  res.json({ received: true });
});
```

### Canceling Subscription

```typescript
async function cancelUserSubscription(subscriptionId: string) {
  const provider = paymentProviderFactory.getProvider('stripe');
  await provider.cancelSubscription(subscriptionId);

  // Update database
  await prisma.subscription.update({
    where: { providerSubscriptionId: subscriptionId },
    data: { status: 'CANCELED' }
  });
}
```

## Dependencies

- **stripe**: Stripe SDK for payment processing
- **@paypal/checkout-server-sdk**: PayPal SDK
- **Prisma**: Database ORM for subscription storage

## Important Notes

### Security Best Practices

**CRITICAL**:
1. **Never commit real keys to Git** - keep `.env` in `.gitignore`
2. **Never use Secret Keys in frontend** - only Publishable Keys (`pk_*`)
3. **Always validate webhook signatures** - reject invalid webhooks
4. **Use different keys for each environment** - test vs live
5. **Rotate keys regularly** - every 6-12 months

### Deployment Checklist

- [ ] Stripe account fully activated and verified
- [ ] Live mode products and prices created
- [ ] Live mode webhook configured with production URL
- [ ] All live mode keys obtained and configured
- [ ] Database seed run with live Price IDs
- [ ] Test real payment with small amount
- [ ] Verify payment appears in Stripe Live Dashboard
- [ ] Verify webhook events are received
- [ ] Check logs for errors

### Testing

**Test Cards** (Stripe Test Mode):
- Success: `4242 4242 4242 4242`
- Declined: `4000 0000 0000 0002`
- 3D Secure: `4000 0027 6000 3184`

More test cards: [Stripe Testing Guide](https://stripe.com/docs/testing)

## Troubleshooting

**"Invalid API Key"**
- Verify key format (test vs live: `sk_test_` vs `sk_live_`)
- Check key is correctly copied (no extra spaces)
- Ensure backend and frontend keys match environment

**"Webhook signature verification failed"**
- Verify `STRIPE_WEBHOOK_SECRET` matches webhook in Stripe Dashboard
- Check webhook URL is correct
- Ensure webhook is using correct mode (test/live)

**"Price ID not found"**
- Verify Price ID exists in correct mode (test/live)
- Check Price ID is correctly copied
- Run `npm run db:seed:force` after updating Price IDs

**"Payment succeeded but subscription not activated"**
- Check webhook is configured and receiving events
- Review backend logs for errors
- Verify database connection

## See Also

- **Stripe API Documentation**: https://stripe.com/docs/api
- **Stripe Testing Guide**: https://stripe.com/docs/testing
- **Stripe Webhook Guide**: https://stripe.com/docs/webhooks
- **PayPal Developer Documentation**: https://developer.paypal.com/docs/
- **Credits System**: `backend/src/services/creditService.ts` - For credit-based features
