generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Assistant {
  id                      String                    @id
  name                    String
  description             String?
  instructions            String
  defaultCharacterId      String?
  visibility              Visibility                @default(PRIVATE)
  userId                  String
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  Character               Character?                @relation(fields: [defaultCharacterId], references: [id])
  User                    User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  ConversationParticipant ConversationParticipant[]

  @@index([defaultCharacterId])
  @@index([userId])
  @@index([visibility])
}

model Attire {
  id                                       String       @id
  name                                     String
  description                              String?
  gender                                   String?
  promptHead                               String?
  promptBody                               String?
  promptFull                               String?
  previewImageUrl                          String?
  originalLanguageCode                     String?
  visibility                               Visibility   @default(PRIVATE)
  userId                                   String
  ageRating                                AgeRating    @default(L)
  contentTags                              ContentTag[]
  contentVersion                           Int          @default(1)
  createdAt                                DateTime     @default(now())
  updatedAt                                DateTime
  User                                     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Character_Character_mainAttireIdToAttire Character[]  @relation("Character_mainAttireIdToAttire")
  Character_CharacterAttires               Character[]  @relation("CharacterAttires")

  @@index([ageRating])
  @@index([userId])
  @@index([visibility])
}

model Character {
  id                                                                                 String                    @id
  firstName                                                                          String
  lastName                                                                           String?
  age                                                                                Int?
  gender                                                                             String?
  species                                                                            String?
  style                                                                              String?
  avatar                                                                             String?
  physicalCharacteristics                                                            String?
  personality                                                                        String?
  history                                                                            String?
  visibility                                                                         Visibility                @default(PUBLIC)
  isSystemCharacter                                                                  Boolean                   @default(false)
  originalLanguageCode                                                               String?
  ageRating                                                                          AgeRating                 @default(L)
  contentTags                                                                        ContentTag[]
  userId                                                                             String
  loraId                                                                             String?
  mainAttireId                                                                       String?
  contentVersion                                                                     Int                       @default(1)
  createdAt                                                                          DateTime                  @default(now())
  updatedAt                                                                          DateTime
  Assistant                                                                          Assistant[]
  Lora                                                                               Lora?                     @relation(fields: [loraId], references: [id])
  Attire_Character_mainAttireIdToAttire                                              Attire?                   @relation("Character_mainAttireIdToAttire", fields: [mainAttireId], references: [id])
  User                                                                               User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  CharacterImage                                                                     CharacterImage[]
  CharacterSticker                                                                   CharacterSticker[]
  ConversationParticipant_ConversationParticipant_actingCharacterIdToCharacter       ConversationParticipant[] @relation("ConversationParticipant_actingCharacterIdToCharacter")
  ConversationParticipant_ConversationParticipant_representingCharacterIdToCharacter ConversationParticipant[] @relation("ConversationParticipant_representingCharacterIdToCharacter")
  Attire_CharacterAttires                                                            Attire[]                  @relation("CharacterAttires")
  Story                                                                              Story[]
  Tag                                                                                Tag[]

  @@index([ageRating])
  @@index([isSystemCharacter])
  @@index([loraId])
  @@index([mainAttireId])
  @@index([userId])
  @@index([visibility])
}

model CharacterImage {
  id          String       @id
  characterId String
  type        ImageType
  url         String
  key         String?
  width       Int?
  height      Int?
  sizeBytes   Int?
  contentType String?
  ageRating   AgeRating    @default(L)
  contentTags ContentTag[] @default([])
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  Character   Character    @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([ageRating])
  @@index([characterId])
  @@index([type])
}

model CharacterSticker {
  id          String        @id
  characterId String
  emotionTag  String?
  actionTag   String?
  imageUrl    String?
  promptUsed  String?
  status      StickerStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  Character   Character     @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([status])
}

model ContentClassification {
  id             String       @id
  ageRating      AgeRating
  contentTags    ContentTag[]
  reason         String?
  contentType    String
  contentId      String
  autoClassified Boolean      @default(true)
  reviewedBy     String?
  reviewedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime

  @@unique([contentType, contentId])
  @@index([ageRating])
  @@index([contentType])
}

model ContentTranslation {
  id                   String            @id
  contentType          String
  contentId            String
  fieldName            String
  originalLanguageCode String
  targetLanguageCode   String
  originalText         String
  translatedText       String
  translationProvider  String?
  translationModel     String?
  confidence           Float?
  status               TranslationStatus @default(ACTIVE)
  reviewedBy           String?
  reviewedAt           DateTime?
  translationTimeMs    Int?
  characterCount       Int?
  sourceVersion        Int               @default(1)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime

  @@unique([contentType, contentId, fieldName, targetLanguageCode])
  @@index([contentType, contentId])
  @@index([originalLanguageCode, targetLanguageCode])
  @@index([status])
  @@index([targetLanguageCode])
}

model Conversation {
  id                      String                    @id
  title                   String                    @default("New Conversation")
  isTitleUserEdited       Boolean                   @default(false)
  isTitleSystemEdited     Boolean                   @default(false)
  projectId               String?
  storyId                 String?
  settings                Json?
  lastMessageAt           DateTime?
  titleLastUpdatedAt      DateTime?
  memoryLastUpdatedAt     DateTime?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  userId                  String
  visibility              Visibility                @default(PRIVATE)
  Story                   Story?                    @relation(fields: [storyId], references: [id])
  User                    User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  ConversationParticipant ConversationParticipant[]
  Message                 Message[]

  @@index([lastMessageAt])
  @@index([projectId])
  @@index([storyId])
  @@index([userId])
  @@index([visibility])
}

model ConversationParticipant {
  id                                                                   String       @id
  conversationId                                                       String
  userId                                                               String?
  actingCharacterId                                                    String?
  actingAssistantId                                                    String?
  representingCharacterId                                              String?
  configOverride                                                       String?
  joinedAt                                                             DateTime     @default(now())
  Assistant                                                            Assistant?   @relation(fields: [actingAssistantId], references: [id], onDelete: Cascade)
  Character_ConversationParticipant_actingCharacterIdToCharacter       Character?   @relation("ConversationParticipant_actingCharacterIdToCharacter", fields: [actingCharacterId], references: [id], onDelete: Cascade)
  Conversation                                                         Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  Character_ConversationParticipant_representingCharacterIdToCharacter Character?   @relation("ConversationParticipant_representingCharacterIdToCharacter", fields: [representingCharacterId], references: [id])
  User                                                                 User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([actingAssistantId])
  @@index([actingCharacterId])
  @@index([conversationId, actingAssistantId])
  @@index([conversationId, actingCharacterId])
  @@index([conversationId])
  @@index([representingCharacterId])
  @@index([userId])
}

model FavoriteCharacter {
  id          String   @id
  userId      String
  characterId String
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, characterId])
  @@index([characterId])
  @@index([userId])
}

model Lora {
  id               String      @id
  civitaiModelId   String?
  civitaiVersionId String?     @unique
  name             String
  modelType        String?
  baseModel        String?
  downloadCount    Int?        @default(0)
  modelUrl         String?
  tags             String[]
  trainedWords     String[]
  nsfw             Boolean     @default(false)
  filename         String?
  filepathRelative String?
  firstImageUrl    String?
  imageUrls        String[]
  category         String?
  term             String?
  deleted          Boolean     @default(false)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  Character        Character[]

  @@index([civitaiModelId])
  @@index([civitaiVersionId])
  @@index([deleted])
}

model Message {
  id             String       @id
  conversationId String
  senderId       String
  senderType     SenderType
  content        String
  attachments    String?
  metadata       Json?
  timestamp      DateTime     @default(now())
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, timestamp])
  @@index([senderId])
}

model Story {
  id                   String         @id
  title                String
  synopsis             String?
  initialText          String?
  coverImage           String?
  objectives           Json?
  authorId             String
  ageRating            AgeRating      @default(L)
  contentTags          ContentTag[]
  visibility           Visibility     @default(PRIVATE)
  contentVersion       Int            @default(1)
  originalLanguageCode String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime
  Conversation         Conversation[]
  User                 User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  Character            Character[]
  Tag                  Tag[]

  @@index([authorId])
  @@index([visibility])
}

model Tag {
  id                   String       @id
  name                 String
  description          String?
  type                 TagType
  ageRating            AgeRating    @default(L)
  contentTags          ContentTag[]
  originalLanguageCode String?
  weight               Int          @default(1)
  searchable           Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime
  Character            Character[]
  Story                Story[]

  @@unique([name, type])
  @@index([ageRating])
  @@index([searchable])
  @@index([type])
}

model User {
  id                      String                    @id
  provider                AuthProvider
  providerAccountId       String
  username                String?                   @unique
  email                   String?                   @unique
  displayName             String?
  fullName                String?
  avatarUrl               String?
  avatarSource            AvatarSource              @default(PROVIDER)
  avatarUpdatedAt         DateTime?
  birthDate               DateTime?
  gender                  String?
  preferredLanguage       String?                   @default("en")
  role                    UserRole                  @default(BASIC)
  lastLoginAt             DateTime                  @default(now())
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  maxAgeRating            AgeRating                 @default(EIGHTEEN)
  blockedTags             ContentTag[]
  Assistant               Assistant[]
  Attire                  Attire[]
  Character               Character[]
  Conversation            Conversation[]
  ConversationParticipant ConversationParticipant[]
  FavoriteCharacter       FavoriteCharacter[]
  Story                   Story[]
  credit_transactions     credit_transactions[]
  usage_logs              usage_logs[]
  user_monthly_balances   user_monthly_balances[]
  user_plans              user_plans[]
  user_plus_access        user_plus_access[]

  @@unique([provider, providerAccountId])
}

model credit_transactions {
  id                   String                @id
  user_id              String
  transaction_type     CreditTransactionType
  amount_credits       Float
  balance_after        Float?
  notes                String?
  related_usage_log_id String?
  related_plan_id      String?
  timestamp            DateTime              @default(now())
  User                 User                  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([timestamp])
  @@index([transaction_type])
  @@index([user_id])
  @@index([user_id, timestamp])
}

model plans {
  id                String       @id
  tier              PlanTier     @unique
  name              String
  price_monthly     Float
  credits_per_month Int
  description       String?
  features          Json?
  is_active         Boolean      @default(true)
  created_at        DateTime     @default(now())
  updated_at        DateTime
  paypal_plan_id    String?      @unique
  user_plans        user_plans[]

  @@index([is_active])
  @@index([tier])
}

model service_credit_costs {
  id                 String   @id
  service_identifier String   @unique
  credits_per_unit   Float
  unit_description   String
  is_active          Boolean  @default(true)
  created_at         DateTime @default(now())
  updated_at         DateTime

  @@index([is_active])
  @@index([service_identifier])
}

model usage_logs {
  id               String      @id
  user_id          String
  service_type     ServiceType
  input_tokens     Int?
  output_tokens    Int?
  character_count  Int?
  image_count      Int?        @default(1)
  credits_consumed Float?
  processed        Boolean     @default(false)
  processed_at     DateTime?
  metadata         Json?
  timestamp        DateTime    @default(now())
  User             User        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([processed])
  @@index([service_type])
  @@index([timestamp])
  @@index([user_id])
  @@index([user_id, processed])
}

model user_monthly_balances {
  id               String   @id
  user_id          String
  month_start_date DateTime
  starting_balance Float
  credits_granted  Float    @default(0)
  credits_spent    Float    @default(0)
  ending_balance   Float
  created_at       DateTime @default(now())
  updated_at       DateTime
  User             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, month_start_date])
  @@index([month_start_date])
  @@index([user_id])
}

model user_plans {
  id                      String             @id
  user_id                 String
  plan_id                 String
  status                  SubscriptionStatus @default(ACTIVE)
  current_period_end      DateTime
  cancel_at_period_end    Boolean            @default(false)
  canceled_at             DateTime?
  created_at              DateTime           @default(now())
  updated_at              DateTime
  last_credits_granted_at DateTime?
  paypal_subscription_id  String?            @unique
  current_period_start    DateTime
  plans                   plans              @relation(fields: [plan_id], references: [id])
  User                    User               @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([current_period_end])
  @@index([paypal_subscription_id])
  @@index([plan_id])
  @@index([status])
  @@index([user_id])
}

model user_plus_access {
  id         String   @id
  user_id    String
  granted_by String?
  reason     String?
  start_date DateTime
  end_date   DateTime
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime
  User       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([end_date])
  @@index([is_active])
  @@index([user_id])
}

enum AgeRating {
  L
  TEN
  TWELVE
  FOURTEEN
  SIXTEEN
  EIGHTEEN
}

enum AuthProvider {
  GOOGLE
  FACEBOOK
}

enum AvatarSource {
  PROVIDER
  UPLOADED
}

enum ContentTag {
  VIOLENCE
  GORE
  SEXUAL
  NUDITY
  LANGUAGE
  DRUGS
  ALCOHOL
  HORROR
  PSYCHOLOGICAL
  DISCRIMINATION
  CRIME
  GAMBLING
}

enum CreditTransactionType {
  GRANT_INITIAL
  GRANT_PLAN
  PURCHASE
  CONSUMPTION
  SYSTEM_REWARD
  REFUND
  ADJUSTMENT
  REFERRAL_BONUS
  PROMOTIONAL
}

enum ImageType {
  AVATAR
  COVER
  SAMPLE
  STICKER
  OTHER
}

enum PlanTier {
  FREE
  PLUS
  PREMIUM
}

enum SenderType {
  USER
  CHARACTER
  ASSISTANT
  SYSTEM
}

enum ServiceType {
  LLM_CHAT_SAFE
  LLM_CHAT_NSFW
  LLM_STORY_GENERATION_SFW
  LLM_STORY_GENERATION_NSFW
  IMAGE_GENERATION
  TTS_DEFAULT
  STT_DEFAULT
}

enum StickerStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAYMENT_FAILED
}

enum TagType {
  CHARACTER
  STORY
  ASSET
  GAME
  MEDIA
  GENERAL
}

enum TranslationStatus {
  PENDING
  ACTIVE
  OUTDATED
  FAILED
  REVIEWED
}

enum UserRole {
  BASIC
  PREMIUM
  ADMIN
}

enum Visibility {
  PRIVATE
  UNLISTED
  PUBLIC
}
